/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/json/JSONModel","jquery.sap.global","sap/ui/documentation/demoapps/model/sourceFileDownloader","sap/ui/documentation/demoapps/model/formatter","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/library"],function(C,D,J,$,s,f,M,a,F,b){"use strict";return C.extend("sap.ui.documentation.demoapps.controller.App",{formatter:f,onInit:function(){var v=sap.ui.getVersionInfo(),V=new J({isOpenUI5:v&&v.gav&&/openui5/i.test(v.gav)});this.getView().setModel(V,"appView");this._onOrientationChange({landscape:D.orientation.landscape});this._onResize({name:(D.resize.width<=600?"Phone":"NoPhone")});},onBeforeRendering:function(){this._deregisterOrientationChange();},onAfterRendering:function(){this._registerOrientationChange();this._registerResize();},onExit:function(){this._deregisterOrientationChange();this._deregisterResize();},_registerOrientationChange:function(){D.orientation.attachHandler(this._onOrientationChange,this);},_deregisterOrientationChange:function(){D.media.detachHandler(this._onOrientationChange,this);},_registerResize:function(){D.media.attachHandler(this._onResize,this);},_deregisterResize:function(){D.orientation.detachHandler(this._onResize,this);},_onOrientationChange:function(e){this.byId("phoneImage").toggleStyleClass("phoneHeaderImageLandscape",e.landscape);},_onResize:function(e){this.byId("phoneImage").setVisible(e.name==="Phone");this.byId("desktopImage").setVisible(e.name!=="Phone");this.byId("phoneImage").toggleStyleClass("phoneHeaderImageDesktop",e.name==="Phone");},onDownloadButtonPress:function(e){var d=this.byId("downloadDialog");this._oDownloadButton=e.getSource();d.getBinding("items").filter([]);d.open();d._oDialog.setContentHeight("");},onSearch:function(e){e.getParameters().itemsBinding.filter([new F("name",b.Contains,e.getParameters().value)]);},onDownloadPress:function(e){var S=e.getParameters().selectedItem,l=S?S:e.getSource().getParent();this._oDownloadButton.setBusy(true);sap.ui.require(["sap/ui/core/util/File","sap/ui/thirdparty/jszip"],function(c,d){var z=new d();$.getJSON(l.data("config"),function(o){var g=o.files,p=[],h=[];g.forEach(function(i){var P=s(o.cwd+i);P.then(function(j){if(j.errorMessage){h.push(j.errorMessage);}else{z.file(i,j,{base64:false,binary:true});}});p.push(P);});Promise.all(p).then(function(){if(h.length){var i=h.reduce(function(E,k){return E+k+"\n";},"Could not locate the following download files:\n");this._handleError(i);}this._oDownloadButton.setBusy(false);a.show("Downloading for app \""+l.getLabel()+"\" has been started");var j=z.generate({type:"blob"});this._createArchive(c,j,l.getLabel());}.bind(this));}.bind(this));}.bind(this));},createDemoAppRow:function(i,B){var o;if(!B.getObject().categoryId){if(B.getObject().teaser){try{jQuery.sap.registerResourcePath("test-resources","test-resources");var r=jQuery.sap.getResourcePath(B.getObject().teaser);var t=sap.ui.xmlfragment(i,r);o=sap.ui.xmlfragment(i,"sap.ui.documentation.demoapps.view.BlockLayoutTeaserCell",this);o.getContent()[0].addContent(t);jQuery.sap.registerResourcePath("test-resources",null);}catch(e){jQuery.sap.log.warning("Teaser for demo app \""+B.getObject().name+"\" could not be loaded: "+e);o=sap.ui.xmlfragment(i,"sap.ui.documentation.demoapps.view.BlockLayoutCell",this);}}else{o=sap.ui.xmlfragment(i,"sap.ui.documentation.demoapps.view.BlockLayoutCell",this);}}else{o=sap.ui.xmlfragment(i,"sap.ui.documentation.demoapps.view.BlockLayoutHeadlineCell",this);}o.setBindingContext(B);return o;},_createArchive:function(c,o,d){c.save(o,d,"zip","application/zip");},_handleError:function(e){M.error(e);},handleLandingImageLoad:function(){this.getView().byId("landingImageHeadline").setVisible(true);}});});
