/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/documentation/sdk/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/GroupHeaderListItem"],function(B,J,G){"use strict";return B.extend("sap.ui.documentation.sdk.controller.SearchPage",{onInit:function(){this.setModel(new J());this.bindListResults();this.getRouter().getRoute("search").attachPatternMatched(this._onTopicMatched,this);},bindListResults:function(){this.dataObject={data:[]};this.getModel().setData(this.dataObject);},_onTopicMatched:function(a){var t=this,q=a.getParameter("arguments").searchParam;this.dataObject.searchTerm=q;this.getModel().refresh();try{this.hideMasterSide();}catch(e){jQuery.sap.log.error(e);}var Q="(category:topics) AND ("+encodeURIComponent(q)+")";var s="(category:apiref) AND ("+encodeURIComponent(q)+")";var b="(category:entity) AND ("+encodeURIComponent(q)+")";var P=new Promise(function(r){jQuery.ajax({url:"search?q="+Q,dataType:"json",success:function(D,S,x){r(D,S,x);},error:function(){r([]);}});});var c=new Promise(function(r){jQuery.ajax({url:"search?q="+s,dataType:"json",success:function(D,S,x){r(D,S,x);},error:function(){r([]);}});});var d=new Promise(function(r){jQuery.ajax({url:"search?q="+b,dataType:"json",success:function(D,S,x){r(D,S,x);},error:function(){r([]);}});});Promise.all([P,c,d]).then(function(r){var D={},R=r[0][0]||{},o=r[1][0]||{},f=r[2][0]||{};R.matches=R.matches||[];o.matches=o.matches||[];f.matches=f.matches||[];D.success=R.success||o.success||f.success||false;D.totalHits=(R.totalHits+o.totalHits+f.totalHits)||0;D.matches=R.matches.concat(o.matches).concat(f.matches);t.processResult(D);}).catch(function(r){});},processResult:function(d){this.dataObject.data=[];this.dataObject.dataAPI=[];this.dataObject.dataDoc=[];this.dataObject.dataExplored=[];this.dataObject.AllLength=0;this.dataObject.APILength=0;this.dataObject.DocLength=0;this.dataObject.ExploredLength=0;if(d&&d.success){if(d.totalHits==0){jQuery(".sapUiRrNoData").html("No matches found.");}else{for(var i=0;i<d.matches.length;i++){var D=d.matches[i];D.modifiedStr=D.modified+"";var m=D.modifiedStr.substring(0,4)+"/"+D.modifiedStr.substring(4,6)+"/"+D.modifiedStr.substring(6,8)+", "+D.modifiedStr.substring(8,10)+":"+D.modifiedStr.substring(10),n=D.path,s=false,c;if(n.indexOf("topic/")===0){n=n.substring("topic/".length,n.lastIndexOf(".html"));n="topicId/"+n;s=true;c="Documentation";this.dataObject.dataDoc.push({index:this.dataObject.DocLength,title:D.title?D.title:"Untitled",path:n,summary:D.summary?(D.summary+"..."):"",score:D.score,modified:m,category:c});this.dataObject.DocLength++;}else if(n.indexOf("entity/")===0){s=true;c="Samples";this.dataObject.dataExplored.push({index:this.dataObject.ExploredLength,title:D.title?D.title:"Untitled",path:n,summary:D.summary?(D.summary+"..."):"",score:D.score,modified:m,category:c});this.dataObject.ExploredLength++;}else if(n.indexOf("docs/api/symbols/")===0){n=n.substring("docs/api/symbols/".length,n.lastIndexOf(".html"));n="apiId/"+n;s=true;c="API Reference";this.dataObject.dataAPI.push({index:this.dataObject.APILength,title:D.title?D.title:"Untitled",path:n,summary:D.summary?(D.summary+"..."):"",score:D.score,modified:m,category:c});this.dataObject.APILength++;}if(s){this.dataObject.data.push({index:i,title:D.title?D.title:"Untitled",path:n,summary:D.summary?(D.summary+"..."):"",score:D.score,modified:m,category:c});this.dataObject.AllLength++;}}}}else{jQuery(".sapUiRrNoData").html("Search failed, please retry ...");}this.getModel().refresh();},getGroupHeader:function(g){return new G({title:g.key,upperCase:false});},categoryAPIFormatter:function(c){return c==="API Reference";},categoryDocFormatter:function(c){return c==="Documentation";},categoryExploredFormatter:function(c){return c==="Samples";},onAllLoadMore:function(e){this.dataObject.visibleAllLength=e.getParameter("actual");this.getModel().refresh();},onAPILoadMore:function(e){this.dataObject.visibleAPILength=e.getParameter("actual");this.getModel().refresh();},onDocLoadMore:function(e){this.dataObject.visibleDocLength=e.getParameter("actual");this.getModel().refresh();},onExploredLoadMore:function(e){this.dataObject.visibleExploredLength=e.getParameter("actual");this.getModel().refresh();},openSearchResult:function(c){var n,C=c.getSource().getCustomData()[0];if(C.getKey()==="path"){n=C.getValue().split("/");}this.getRouter().navTo(n[0],{id:n[1]},false);}});});
